# To start Docker in Swarm mode, you need to run `docker swarm init`
# To deploy the Grid, `docker stack deploy -c docker-compose.yml grid`
# Stop with `docker stack rm grid`

# "build" isn't supported in swarm mode, so build loadtester separately

version: '3.7'

services:
  hub:
    image: selenium/hub:3.141.59-iron
    ports:
      - "4444:4444"

  chrome:
    image: selenium/node-chrome:3.141.59-iron
    volumes:
      - /dev/shm:/dev/shm
    environment:
      HUB_HOST: hub
      HUB_PORT: 4444
      START_XVFB: "false"
    deploy:
        replicas: 5
    entrypoint: bash -c 'SE_OPTS="-host $$HOSTNAME" /opt/bin/entry_point.sh'

  tester:
    build: ./
    image: loadtester:0.1
    tty: true
    # command: bash
    command: ./wait_for_grid.sh pytest
    volumes:
      - ./:/usr/src/app
